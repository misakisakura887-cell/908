generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique @map("wallet_address")
  nonce         String   @default(uuid())
  createdAt     DateTime @default(now()) @map("created_at")
  lastLogin     DateTime? @map("last_login")

  positions UserPosition[]
  sessions  Session[]

  @@index([walletAddress])
  @@map("users")
}

model Strategy {
  id          String   @id @default(uuid())
  name        String
  description String?
  strategyType String  @map("strategy_type")
  assetClass  String   @map("asset_class")
  riskLevel   Int      @map("risk_level")
  
  custodyAddress String? @map("custody_address")
  
  totalReturn  Decimal? @db.Decimal(10, 4) @map("total_return")
  sharpeRatio  Decimal? @db.Decimal(10, 4) @map("sharpe_ratio")
  maxDrawdown  Decimal? @db.Decimal(10, 4) @map("max_drawdown")
  winRate      Decimal? @db.Decimal(5, 2) @map("win_rate")
  
  totalAum     Decimal  @default(0) @db.Decimal(20, 2) @map("total_aum")
  followerCount Int     @default(0) @map("follower_count")
  
  isActive    Boolean  @default(true) @map("is_active")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  positions UserPosition[]
  trades    Trade[]
  performance StrategyPerformance[]

  @@index([strategyType])
  @@index([isActive])
  @@map("strategies")
}

model UserPosition {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  strategyId String @map("strategy_id")
  
  investedAmount  Decimal @db.Decimal(20, 2) @map("invested_amount")
  currentValue    Decimal @db.Decimal(20, 2) @map("current_value")
  
  realizedPnl     Decimal @default(0) @db.Decimal(20, 2) @map("realized_pnl")
  unrealizedPnl   Decimal @default(0) @db.Decimal(20, 2) @map("unrealized_pnl")
  
  entryTime    DateTime @default(now()) @map("entry_time")
  lastUpdate   DateTime @default(now()) @map("last_update")
  
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@unique([userId, strategyId])
  @@index([userId])
  @@index([strategyId])
  @@map("user_positions")
}

model Trade {
  id         String   @id @default(uuid())
  strategyId String   @map("strategy_id")
  
  symbol     String
  side       String
  quantity   Decimal  @db.Decimal(20, 8)
  price      Decimal  @db.Decimal(20, 8)
  
  orderId    String?  @map("order_id")
  status     String   @default("pending")
  
  fee        Decimal  @default(0) @db.Decimal(20, 8)
  
  executedAt DateTime? @map("executed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  
  strategy Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@index([strategyId])
  @@index([symbol])
  @@index([executedAt])
  @@map("trades")
}

model StrategyPerformance {
  id         String   @id @default(uuid())
  strategyId String   @map("strategy_id")
  
  date       DateTime @db.Date
  dailyReturn      Decimal? @db.Decimal(10, 4) @map("daily_return")
  cumulativeReturn Decimal? @db.Decimal(10, 4) @map("cumulative_return")
  
  aum        Decimal? @db.Decimal(20, 2)
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  strategy Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  @@unique([strategyId, date])
  @@index([strategyId, date])
  @@map("strategy_performance")
}

model Session {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tokenHash String   @map("token_hash")
  
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("sessions")
}
